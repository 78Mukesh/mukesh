<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Daily Food Tracker</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
    }
    .hover-scale {
      transition: transform 0.2s ease-in-out;
    }
    .hover-scale:hover {
      transform: scale(1.02);
    }
    .input-focus {
      transition: border-color 0.3s ease, box-shadow 0.3s ease;
    }
    .input-focus:focus {
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    .sort-icon::after {
      content: '↕';
      display: inline-block;
      margin-left: 4px;
    }
    .sort-asc::after {
      content: '↑';
    }
    .sort-desc::after {
      content: '↓';
    }
    .date-input-container {
      position: relative;
    }
    #toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background-color: #10b981;
      color: white;
      padding: 12px 16px;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      opacity: 0;
      transition: opacity 0.3s ease;
      z-index: 1000;
    }
    #toast.show {
      opacity: 1;
    }
    .autocomplete-dropdown {
      position: absolute;
      width: 100%;
      max-height: 200px;
      overflow-y: auto;
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      z-index: 10;
      display: none;
    }
    .autocomplete-item {
      padding: 8px 12px;
      cursor: pointer;
    }
    .autocomplete-item:hover {
      background: #f3f4f6;
    }
    @media (max-width: 640px) {
      .container {
        padding: 1rem;
      }
      h1 {
        font-size: 1.5rem;
      }
      button, input, select, textarea {
        font-size: 0.9rem;
      }
      table {
        font-size: 0.9rem;
      }
      th, td {
        padding: 0.5rem;
      }
    }
    @media print {
      .no-print {
        display: none !important;
      }
      .print-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 12pt;
      }
      .print-table th, .print-table td {
        border: 1px solid #000;
        padding: 8px;
        text-align: left;
      }
      .print-table th {
        background-color: #f0f0f0;
        font-weight: bold;
      }
      .print-title {
        text-align: center;
        font-size: 16pt;
        margin-bottom: 20px;
      }
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col items-center p-4 sm:p-6">
  <div class="w-full max-w-5xl bg-white rounded-2xl shadow-lg p-4 sm:p-8 container">
    <h1 class="text-2xl sm:text-3xl font-bold text-gray-800 text-center mb-6 sm:mb-8 no-print">Daily Food Tracker</h1>
    
    <div class="mb-6 sm:mb-8 bg-gray-50 p-4 sm:p-6 rounded-xl shadow-sm no-print">
      <div class="grid grid-cols-1 gap-4 sm:gap-6">
        <div class="date-input-container">
          <label for="date" class="block text-sm font-medium text-gray-700 mb-1">Date</label>
          <input type="date" id="date" class="w-full p-3 border border-gray-300 rounded-lg input-focus">
        </div>
        <div class="relative">
          <label for="morning" class="block text-sm font-medium text-gray-700 mb-1">Morning</label>
          <textarea id="morning" class="w-full p-3 border border-gray-300 rounded-lg input-focus" rows="3" placeholder="What did you eat in the morning?" oninput="showAutocomplete('morning')" onblur="hideAutocomplete('morning')"></textarea>
          <ul id="morning-autocomplete" class="autocomplete-dropdown"></ul>
        </div>
        <div class="relative">
          <label for="afternoon" class="block text-sm font-medium text-gray-700 mb-1">Afternoon</label>
          <textarea id="afternoon" class="w-full p-3 border border-gray-300 rounded-lg input-focus" rows="3" placeholder="What did you eat in the afternoon?" oninput="showAutocomplete('afternoon')" onblur="hideAutocomplete('afternoon')"></textarea>
          <ul id="afternoon-autocomplete" class="autocomplete-dropdown"></ul>
        </div>
        <div>
          <label for="snacks" class="block text-sm font-medium text-gray-700 mb-1">Snacks</label>
          <textarea id="snacks" class="w-full p-3 border border-gray-300 rounded-lg input-focus" rows="3" placeholder="What snacks did you have?"></textarea>
        </div>
        <div class="relative">
          <label for="night" class="block text-sm font-medium text-gray-700 mb-1">Night</label>
          <textarea id="night" class="w-full p-3 border border-gray-300 rounded-lg input-focus" rows="3" placeholder="What did you eat at night?" oninput="showAutocomplete('night')" onblur="hideAutocomplete('night')"></textarea>
          <ul id="night-autocomplete" class="autocomplete-dropdown"></ul>
        </div>
      </div>
      <div class="flex flex-col sm:flex-row gap-4 mt-4 sm:mt-6">
        <button onclick="saveEntry()" class="flex-1 bg-blue-600 text-white p-3 rounded-lg font-medium hover:bg-blue-700 hover-scale">Save Entry</button>
        <button onclick="clearForm()" class="flex-1 bg-gray-600 text-white p-3 rounded-lg font-medium hover:bg-gray-700 hover-scale">Clear Form</button>
      </div>
    </div>

    <div class="flex flex-col sm:flex-row gap-4 mb-6 no-print">
      <button onclick="exportEntries()" class="flex-1 bg-green-600 text-white p-3 rounded-lg font-medium hover:bg-green-700 hover-scale">Export to JSON</button>
      <button onclick="exportCSV()" class="flex-1 bg-teal-600 text-white p-3 rounded-lg font-medium hover:bg-teal-700 hover-scale">Export to CSV</button>
      <button onclick="printEntries()" class="flex-1 bg-yellow-600 text-white p-3 rounded-lg font-medium hover:bg-yellow-700 hover-scale">Print Entries</button>
      <button onclick="emailEntries()" class="flex-1 bg-indigo-600 text-white p-3 rounded-lg font-medium hover:bg-indigo-700 hover-scale">Email Entries</button>
      <label class="flex-1 bg-purple-600 text-white p-3 rounded-lg font-medium hover:bg-purple-700 hover-scale text-center cursor-pointer">
        Import Entries
        <input type="file" id="importFile" accept=".json" class="hidden" onchange="importEntries(event)">
      </label>
    </div>

    <div class="flex flex-col sm:flex-row gap-4 mb-6 no-print">
      <input type="text" id="search" placeholder="Search by date or meal..." class="flex-1 p-3 border border-gray-300 rounded-lg input-focus" oninput="loadEntries()">
      <select id="filter" class="p-3 border border-gray-300 rounded-lg input-focus" onchange="loadEntries()">
        <option value="all">All Meals</option>
        <option value="morning">Morning</option>
        <option value="afternoon">Afternoon</option>
        <option value="snacks">Snacks</option>
        <option value="night">Night</option>
      </select>
      <select id="monthFilter" class="p-3 border border-gray-300 rounded-lg input-focus" onchange="loadEntries()">
        <option value="all">All Months</option>
        <option value="01">January</option>
        <option value="02">February</option>
        <option value="03">March</option>
        <option value="04">April</option>
        <option value="05">May</option>
        <option value="06">June</option>
        <option value="07">July</option>
        <option value="08">August</option>
        <option value="09">September</option>
        <option value="10">October</option>
        <option value="11">November</option>
        <option value="12">December</option>
      </select>
      <div class="date-input-container">
        <input type="date" id="startDate" class="w-full p-3 border border-gray-300 rounded-lg input-focus" onchange="loadEntries()">
      </div>
      <div class="date-input-container">
        <input type="date" id="endDate" class="w-full p-3 border border-gray-300 rounded-lg input-focus" onchange="loadEntries()">
      </div>
    </div>

    <div class="overflow-x-auto rounded-xl border border-gray-200">
      <table class="w-full table-auto border-collapse print-table" role="grid" aria-label="Food tracker entries">
        <thead>
          <tr class="bg-gray-100 text-gray-700">
            <th scope="col" class="px-4 sm:px-6 py-3 sm:py-4 text-left font-semibold cursor-pointer hover:text-blue-600 sort-icon no-print" onclick="sortTable('date')" id="sort-date">Date</th>
            <th scope="col" class="px-4 sm:px-6 py-3 sm:py-4 text-left font-semibold cursor-pointer hover:text-blue-600 sort-icon no-print" onclick="sortTable('morning')" id="sort-morning">Morning</th>
            <th scope="col" class="px-4 sm:px-6 py-3 sm:py-4 text-left font-semibold cursor-pointer hover:text-blue-600 sort-icon no-print" onclick="sortTable('afternoon')" id="sort-afternoon">Afternoon</th>
            <th scope="col" class="px-4 sm:px-6 py-3 sm:py-4 text-left font-semibold cursor-pointer hover:text-blue-600 sort-icon no-print" onclick="sortTable('snacks')" id="sort-snacks">Snacks</th>
            <th scope="col" class="px-4 sm:px-6 py-3 sm:py-4 text-left font-semibold cursor-pointer hover:text-blue-600 sort-icon no-print" onclick="sortTable('night')" id="sort-night">Night</th>
            <th scope="col" class="px-4 sm:px-6 py-3 sm:py-4 text-left font-semibold no-print">Actions</th>
            <!-- Print-only headers -->
            <th scope="col" class="px-4 sm:px-6 py-3 sm:py-4 text-left font-semibold print-only" style="display: none;">Date</th>
            <th scope="col" class="px-4 sm:px-6 py-3 sm:py-4 text-left font-semibold print-only" style="display: none;">Morning</th>
            <th scope="col" class="px-4 sm:px-6 py-3 sm:py-4 text-left font-semibold print-only" style="display: none;">Afternoon</th>
            <th scope="col" class="px-4 sm:px-6 py-3 sm:py-4 text-left font-semibold print-only" style="display: none;">Snacks</th>
            <th scope="col" class="px-4 sm:px-6 py-3 sm:py-4 text-left font-semibold print-only" style="display: none;">Night</th>
          </tr>
        </thead>
        <tbody id="table-entries" role="rowgroup" class="text-gray-600"></tbody>
      </table>
    </div>

    <div id="toast"></div>
  </div>

  <script>
    // Remove duplicates from food items
    const rawFoodItems = {
      morning: [
        { name: 'Idli', category: '🥣 Breakfast' },
        { name: 'Sambar', category: '🥣 Breakfast' },
        { name: 'Chutney', category: '🥣 Breakfast' },
        { name: 'Upma', category: '🥣 Breakfast' },
        { name: 'Coconut Chutney', category: '🥣 Breakfast' },
        { name: 'Vada', category: '🥣 Breakfast' },
        { name: 'Semiya Upma', category: '🥣 Breakfast' },
        { name: 'Pongal', category: '🥣 Breakfast' },
        { name: 'Bonda', category: '🥣 Breakfast' },
        { name: 'Chapati', category: '🥣 Breakfast' },
        { name: 'Puri', category: '🥣 Breakfast' },
        { name: 'Idli, Sambar, Chutney', category: '🥣 Breakfast' },
        { name: 'Upma, Coconut Chutney', category: '🥣 Breakfast' },
        { name: 'Vada, Chutney', category: '🥣 Breakfast' },
        { name: 'Pongal, Chutney', category: '🥣 Breakfast' },
        { name: 'Bonda, Chutney', category: '🥣 Breakfast' },
        { name: 'Chapati, Puri or Dosa', category: '🥣 Breakfast' },
        { name: 'Dosa', category: '🥣 Breakfast' }
      ],
      afternoon: [
        { name: 'Tomato Bath', category: '🍛 Lunch' },
        { name: 'Cucumber Raita', category: '🍛 Lunch' },
        { name: 'White Rice', category: '🍛 Lunch' },
        { name: 'Dal', category: '🍛 Lunch' },
        { name: 'Aloo Fry', category: '🍛 Lunch' },
        { name: 'Rice', category: '🍛 Lunch' },
        { name: 'Pappu', category: '🍛 Lunch' },
        { name: 'Ladies-finger Fry', category: '🍛 Lunch' },
        { name: 'Pulav', category: '🍛 Lunch' },
        { name: 'Raita', category: '🍛 Lunch' },
        { name: 'Aloo Curry', category: '🍛 Lunch' },
        { name: 'Vegetable Curry', category: '🍛 Lunch' },
        { name: 'Veg Biryani', category: '🍛 Lunch' },
        { name: 'Baggara Rice', category: '🍛 Lunch' },
        { name: 'Tomato Bath, Cucumber Raita', category: '🍛 Lunch' },
        { name: 'White Rice, Dal, Aloo Fry', category: '🍛 Lunch' },
        { name: 'Rice, Pappu, Ladies Finger Fry', category: '🍛 Lunch' },
        { name: 'Pulav, Raita', category: '🍛 Lunch' },
        { name: 'White Rice, Aloo Curry', category: '🍛 Lunch' },
        { name: 'Rice, Mixed Vegetable Curry', category: '🍛 Lunch' },
        { name: 'Vegetable Biryani, Raita', category: '🍛 Lunch' },
        { name: 'Bagara Rice', category: '🍛 Lunch' },
      ],
      night: [
        { name: 'Tomato Rasam', category: '🍽️ Dinner' },
        { name: 'White Rice', category: '🍽️ Dinner' },
        { name: 'Sorakaya Chutney', category: '🍽️ Dinner' },
        { name: 'Pappuchaaru', category: '🍽️ Dinner' },
        { name: 'Ladies-finger Fry', category: '🍽️ Dinner' },
        { name: 'Drumstick Sambar', category: '🍽️ Dinner' },
        { name: 'Rice', category: '🍽️ Dinner' },
        { name: 'Papad', category: '🍽️ Dinner' },
        { name: 'Meerala Rasam', category: '🍽️ Dinner' },
        { name: 'Beerakaya Chutney', category: '🍽️ Dinner' },
        { name: 'Pappu Charu', category: '🍽️ Dinner' },
        { name: 'Dondakaya Fry', category: '🍽️ Dinner' },
        { name: 'Jeera Rice', category: '🍽️ Dinner' },
        { name: 'Dal Dhoka', category: '🍽️ Dinner' },
        { name: 'Chapati', category: '🍽️ Dinner' },
        { name: 'Tomato Rasam, White Rice', category: '🍽️ Dinner' },
        { name: 'Sorakaya Chutney, Rice', category: '🍽️ Dinner' },
        { name: 'Pappu Charu, Ladies Finger Fry', category: '🍽️ Dinner' },
        { name: 'Drumstick Sambar, Rice', category: '🍽️ Dinner' },
        { name: 'Miriyala Rasam, Papad', category: '🍽️ Dinner' },
        { name: 'Beerakaya Chutney, Dondakaya Fry', category: '🍽️ Dinner' },
        { name: 'Jeera Rice, Dal Dhokla', category: '🍽️ Dinner' },
        { name: 'Chapati', category: '🍽️ Dinner' }
      ]
    };

    // Remove duplicates by name, keeping the first occurrence
    const foodItems = {
      morning: [...new Map(rawFoodItems.morning.map(item => [item.name, item])).values()],
      afternoon: [...new Map(rawFoodItems.afternoon.map(item => [item.name, item])).values()],
      night: [...new Map(rawFoodItems.night.map(item => [item.name, item])).values()]
    };

    // Autocomplete functionality
    function showAutocomplete(field) {
      const textarea = document.getElementById(field);
      const input = textarea.value.trim();
      const dropdown = document.getElementById(`${field}-autocomplete`);
      dropdown.innerHTML = '';

      const segments = input.split(',').map(s => s.trim());
      const lastInput = segments[segments.length - 1] || '';
      const query = lastInput.toLowerCase();

      if (!query) {
        dropdown.style.display = 'none';
        return;
      }

      const items = foodItems[field].filter(item => item.name.toLowerCase().startsWith(query));

      if (items.length > 0) {
        items.forEach(item => {
          const li = document.createElement('li');
          li.className = 'autocomplete-item';
          li.innerHTML = `${item.category}: ${item.name}`;
          li.onclick = () => {
            const segments = input.split(',').map(s => s.trim());
            const existingContent = segments.length > 1 ? segments.slice(0, -1).join(', ') : '';
            textarea.value = existingContent ? `${existingContent}, ${item.name}` : item.name;
            dropdown.style.display = 'none';
            textarea.focus();
          };
          dropdown.appendChild(li);
        });
        dropdown.style.display = 'block';
      } else {
        dropdown.style.display = 'none';
      }
    }

    function hideAutocomplete(field) {
      setTimeout(() => {
        const dropdown = document.getElementById(`${field}-autocomplete`);
        dropdown.style.display = 'none';
      }, 200);
    }

    // Utility to format YYYY-MM-DD to DD-MM-YYYY
    function formatToDDMMYYYY(dateStr) {
      if (!dateStr) return '';
      const [year, month, day] = dateStr.split('-');
      return `${day}-${month}-${year}`;
    }

    // Utility to format DD-MM-YYYY to YYYY-MM-DD
    function formatToYYYYMMDD(dateStr) {
      if (!dateStr) return '';
      const [day, month, year] = dateStr.split('-');
      return `${year}-${month}-${day}`;
    }

    // Utility to convert DD-MM-YYYY to sortable YYYYMMDD
    function toSortableDate(displayDate) {
      if (!displayDate) return '';
      const [day, month, year] = displayDate.split('-');
      return `${year}${month}${day}`;
    }

    // Sanitize input to prevent XSS
    function sanitizeInput(input) {
      const div = document.createElement('div');
      div.textContent = input;
      return div.innerHTML;
    }

    // Show toast notification
    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.style.backgroundColor = type === 'error' ? '#ef4444' : '#10b981';
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 3000);
    }

    // Set today's date as default in YYYY-MM-DD for input[type=date]
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('date').value = today;

    // Sorting state
    let sortField = 'date';
    let sortDirection = 'asc';

    // Load saved entries from localStorage
    function loadEntries() {
      const entries = JSON.parse(localStorage.getItem('foodEntries') || '[]');
      const search = document.getElementById('search').value.toLowerCase();
      const filter = document.getElementById('filter').value;
      const monthFilter = document.getElementById('monthFilter').value;
      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;
      const tableEntriesBody = document.getElementById('table-entries');
      tableEntriesBody.innerHTML = '';

      const startSortable = startDate ? toSortableDate(formatToDDMMYYYY(startDate)) : '';
      const endSortable = endDate ? toSortableDate(formatToDDMMYYYY(endDate)) : '';

      let filteredEntries = entries.filter(entry => {
        const matchesSearch = entry.date.toLowerCase().includes(search) ||
          (entry.morning || '').toLowerCase().includes(search) ||
          (entry.afternoon || '').toLowerCase().includes(search) ||
          (entry.snacks || '').toLowerCase().includes(search) ||
          (entry.night || '').toLowerCase().includes(search);
        const matchesFilter = filter === 'all' || (filter && entry[filter]);
        const entrySortable = toSortableDate(entry.date);
        const matchesDate = (!startSortable || entrySortable >= startSortable) && (!endSortable || entrySortable <= endSortable);
        const matchesMonth = monthFilter === 'all' || entry.date.split('-')[1] === monthFilter;
        return matchesSearch && matchesFilter && matchesDate && matchesMonth;
      });

      filteredEntries.sort((a, b) => {
        const valA = sortField === 'date' ? toSortableDate(a.date) : (a[sortField] || '');
        const valB = sortField === 'date' ? toSortableDate(b.date) : (b[sortField] || '');
        return sortDirection === 'asc' ? 
          (valA < valB ? -1 : 1) : 
          (valB < valA ? -1 : 1);
      });

      if (filteredEntries.length === 0) {
        tableEntriesBody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-gray-500 no-print">No entries found</td></tr>';
      } else {
        filteredEntries.forEach(entry => {
          const row = document.createElement('tr');
          row.className = 'hover:bg-gray-50';
          row.innerHTML = `
            <td class="border-t px-4 sm:px-6 py-3 sm:py-4">${entry.date}</td>
            <td class="border-t px-4 sm:px-6 py-3 sm:py-4">${entry.morning || 'N/A'}</td>
            <td class="border-t px-4 sm:px-6 py-3 sm:py-4">${entry.afternoon || 'N/A'}</td>
            <td class="border-t px-4 sm:px-6 py-3 sm:py-4">${entry.snacks || 'N/A'}</td>
            <td class="border-t px-4 sm:px-6 py-3 sm:py-4">${entry.night || 'N/A'}</td>
            <td class="border-t px-4 sm:px-6 py-3 sm:py-4 no-print">
              <button onclick="editEntry('${entry.date}')" class="text-blue-600 hover:underline font-medium mr-4">Edit</button>
              <button onclick="deleteEntry('${entry.date}')" class="text-red-600 hover:underline font-medium">Delete</button>
            </td>
          `;
          tableEntriesBody.appendChild(row);
        });
      }
    }

    // Sort table by column
    function sortTable(field) {
      if (sortField === field) {
        sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
      } else {
        sortField = field;
        sortDirection = 'asc';
      }
      document.querySelectorAll('th.sort-icon').forEach(th => th.classList.remove('sort-asc', 'sort-desc'));
      document.getElementById(`sort-${field}`).classList.add(`sort-${sortDirection}`);
      loadEntries();
    }

    // Save or update an entry
    function saveEntry() {
      const dateInput = document.getElementById('date').value;
      if (!dateInput) {
        showToast('Please select a valid date', 'error');
        return;
      }
      const date = formatToDDMMYYYY(dateInput);
      const morning = sanitizeInput(document.getElementById('morning').value.trim());
      const afternoon = sanitizeInput(document.getElementById('afternoon').value.trim());
      const snacks = sanitizeInput(document.getElementById('snacks').value.trim());
      const night = sanitizeInput(document.getElementById('night').value.trim());

      if (!morning && !afternoon && !snacks && !night) {
        showToast('Please fill in at least one meal field', 'error');
        return;
      }

      const entries = JSON.parse(localStorage.getItem('foodEntries') || '[]');
      const newEntry = { date, morning, afternoon, snacks, night };
      const updatedEntries = entries.filter(entry => entry.date !== date);
      updatedEntries.push(newEntry);
      localStorage.setItem('foodEntries', JSON.stringify(updatedEntries));

      clearForm();
      loadEntries();
      showToast('Entry saved successfully');
    }

    // Edit an existing entry
    function editEntry(date) {
      const entries = JSON.parse(localStorage.getItem('foodEntries') || '[]');
      const entry = entries.find(entry => entry.date === date);
      if (entry) {
        document.getElementById('date').value = formatToYYYYMMDD(entry.date);
        document.getElementById('morning').value = entry.morning || '';
        document.getElementById('afternoon').value = entry.afternoon || '';
        document.getElementById('snacks').value = entry.snacks || '';
        document.getElementById('night').value = entry.night || '';
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }
    }

    // Delete an entry
    function deleteEntry(date) {
      if (confirm('Are you sure you want to delete this entry?')) {
        const entries = JSON.parse(localStorage.getItem('foodEntries') || '[]');
        const updatedEntries = entries.filter(entry => entry.date !== date);
        localStorage.setItem('foodEntries', JSON.stringify(updatedEntries));
        loadEntries();
        showToast('Entry deleted successfully');
      }
    }

    // Clear the form
    function clearForm() {
      document.getElementById('date').value = new Date().toISOString().split('T')[0];
      document.getElementById('morning').value = '';
      document.getElementById('afternoon').value = '';
      document.getElementById('snacks').value = '';
      document.getElementById('night').value = '';
      ['morning', 'afternoon', 'night'].forEach(field => hideAutocomplete(field));
    }

    // Escape CSV values to handle commas and quotes
    function escapeCSV(str) {
      if (!str) return '';
      return `"${str.replace(/"/g, '""')}"`;
    }

    // Export entries as JSON
    function exportEntries() {
      try {
        const entries = JSON.parse(localStorage.getItem('foodEntries') || '[]');
        if (entries.length === 0) {
          showToast('No entries to export', 'error');
          return;
        }
        const dataStr = JSON.stringify(entries, null, 2);
        const blob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `food_entries_${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        showToast('JSON exported successfully');
      } catch (error) {
        showToast('Error exporting JSON', 'error');
        console.error('Export JSON error:', error);
      }
    }

    // Export entries as CSV
    function exportCSV() {
      try {
        const entries = JSON.parse(localStorage.getItem('foodEntries') || '[]');
        if (entries.length === 0) {
          showToast('No entries to export', 'error');
          return;
        }
        const headers = ['Date,Morning,Afternoon,Snacks,Night'];
        const rows = entries.map(entry => 
          `${escapeCSV(entry.date)},${escapeCSV(entry.morning || '')},${escapeCSV(entry.afternoon || '')},${escapeCSV(entry.snacks || '')},${escapeCSV(entry.night || '')}`
        );
        const csv = [headers, ...rows].join('\n');
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `food_entries_${new Date().toISOString().split('T')[0]}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        showToast('CSV exported successfully');
      } catch (error) {
        showToast('Error exporting CSV', 'error');
        console.error('Export CSV error:', error);
      }
    }

    // Print entries
    function printEntries() {
      try {
        const entries = JSON.parse(localStorage.getItem('foodEntries') || '[]');
        if (entries.length === 0) {
          showToast('No entries to print', 'error');
          return;
        }

        // Apply sorting and filtering (same as table display)
        const search = document.getElementById('search').value.toLowerCase();
        const filter = document.getElementById('filter').value;
        const monthFilter = document.getElementById('monthFilter').value;
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;

        const startSortable = startDate ? toSortableDate(formatToDDMMYYYY(startDate)) : '';
        const endSortable = endDate ? toSortableDate(formatToDDMMYYYY(endDate)) : '';

        let filteredEntries = entries.filter(entry => {
          const matchesSearch = entry.date.toLowerCase().includes(search) ||
            (entry.morning || '').toLowerCase().includes(search) ||
            (entry.afternoon || '').toLowerCase().includes(search) ||
            (entry.snacks || '').toLowerCase().includes(search) ||
            (entry.night || '').toLowerCase().includes(search);
          const matchesFilter = filter === 'all' || (filter && entry[filter]);
          const entrySortable = toSortableDate(entry.date);
          const matchesDate = (!startSortable || entrySortable >= startSortable) && (!endSortable || entrySortable <= endSortable);
          const matchesMonth = monthFilter === 'all' || entry.date.split('-')[1] === monthFilter;
          return matchesSearch && matchesFilter && matchesDate && matchesMonth;
        });

        filteredEntries.sort((a, b) => {
          const valA = sortField === 'date' ? toSortableDate(a.date) : (a[sortField] || '');
          const valB = sortField === 'date' ? toSortableDate(b.date) : (b[sortField] || '');
          return sortDirection === 'asc' ? 
            (valA < valB ? -1 : 1) : 
            (valB < valA ? -1 : 1);
        });

        // Toggle print-only headers
        document.querySelectorAll('th.print-only').forEach(th => th.style.display = 'table-cell');
        document.querySelectorAll('th.no-print, td.no-print').forEach(el => el.style.display = 'none');

        // Trigger print
        window.print();

        // Restore normal headers
        document.querySelectorAll('th.print-only').forEach(th => th.style.display = 'none');
        document.querySelectorAll('th.no-print, td.no-print').forEach(el => el.style.display = 'table-cell');

        showToast('Print dialog opened');
      } catch (error) {
        showToast('Error preparing print', 'error');
        console.error('Print entries error:', error);
      }
    }

    // Email entries
    function emailEntries() {
      try {
        const entries = JSON.parse(localStorage.getItem('foodEntries') || '[]');
        if (entries.length === 0) {
          showToast('No entries to email', 'error');
          return;
        }
        const formattedEntries = entries.map(entry => 
          `Date: ${entry.date}\n` +
          `Morning: ${entry.morning || 'N/A'}\n` +
          `Afternoon: ${entry.afternoon || 'N/A'}\n` +
          `Snacks: ${entry.snacks || 'N/A'}\n` +
          `Night: ${entry.night || 'N/A'}\n` +
          '---'
        ).join('\n');
        const subject = encodeURIComponent('Daily Food Tracker Entries');
        const body = encodeURIComponent(`Find your food tracker entries below:\n\n${formattedEntries}`);
        const mailtoLink = `mailto:?subject=${subject}&body=${body}`;
        window.location.href = mailtoLink;
        showToast('Email opened with entries');
      } catch (error) {
        showToast('Error preparing email', 'error');
        console.error('Email entries error:', error);
      }
    }

    // Import entries from JSON
    function importEntries(event) {
      const file = event.target.files[0];
      if (!file) return;
      if (!file.name.endsWith('.json')) {
        showToast('Please upload a valid JSON file', 'error');
        return;
      }
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const importedEntries = JSON.parse(e.target.result);
          if (!Array.isArray(importedEntries)) {
            showToast('Invalid JSON format', 'error');
            return;
          }
          const validEntries = importedEntries.filter(entry => 
            entry.date && /^\d{2}-\d{2}-\d{4}$/.test(entry.date) && 
            typeof entry.morning === 'string' && 
            typeof entry.afternoon === 'string' && 
            typeof entry.snacks === 'string' && 
            typeof entry.night === 'string'
          );
          if (validEntries.length === 0) {
            showToast('No valid entries found in the file', 'error');
            return;
          }
          const existingEntries = JSON.parse(localStorage.getItem('foodEntries') || '[]');
          const mergedEntries = [
            ...existingEntries.filter(e => !validEntries.some(ve => ve.date === e.date)),
            ...validEntries
          ];
          localStorage.setItem('foodEntries', JSON.stringify(mergedEntries));
          loadEntries();
          showToast('Entries imported successfully');
        } catch (error) {
          showToast('Error parsing JSON file', 'error');
          console.error('Import JSON error:', error);
        }
      };
      reader.readAsText(file);
    }

    // Load entries on page load
    loadEntries();
  </script>
</body>
</html>